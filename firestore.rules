
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAuthor(userId) {
      return request.auth.uid == userId;
    }

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow public read for published posts
    match /posts/{postId} {
      allow get: if resource.data.status == 'published';
      allow list: if resource.data.status == 'published';

      // Rules for the 'comments' subcollection
      match /comments/{commentId} {
        allow read: if true;

        // Allow create only for authenticated users who are the author
        allow create: if isAuthenticated() && isAuthor(request.resource.data.authorId);

        // Allow update/delete only for the author of the comment
        allow update, delete: if isAuthenticated() && isAuthor(resource.data.authorId);
      }

      // Rules for the 'likes' subcollection
      match /likes/{userId} {
        allow read: if true;

        // Allow create/delete only if the user is acting on their own like document
        allow create, delete: if isAuthenticated() && isAuthor(userId);
      }
    }
    
    // Read-only access for public collections
    match /categories/{categoryId} {
      allow read: if true;
    }
    
    match /tags/{tagId} {
      allow read: if true;
    }

    match /users/{userId} {
      allow read: if true;
    }

    // Allow read for public site settings
    match /site_settings/config {
        allow read: if true;
    }
    
    // Allow read for public widget and navigation data
    match /widget_areas/{areaId} {
        allow read: if true;
    }
    match /widget_instances/{instanceId} {
        allow read: if true;
    }
    match /navigation_menus/{menuId} {
        allow read: if true;
    }
    match /navigation_menu_items/{itemId} {
        allow read: if true;
    }
    match /block_layouts/{layoutId} {
        allow read: if true;
    }
    match /page_sections/{sectionId} {
        allow read: if true;
    }
    match /section_blocks/{blockId} {
        allow read: if true;
    }
    
     // Allow read for published pages
    match /pages/{pageId} {
        allow read: if resource.data.status == 'published';
    }

  }
}
